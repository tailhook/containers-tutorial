<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Build Your Own Docker</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="my.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="linux-containers">Linux Containers</h1></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="process-management">Process Management</h1></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="namespaces">Namespaces</h1></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="chroot">Chroot</h1></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> ls -la /proc/self/root
<span class="go">/
</span><span class="gp">#</span> chroot /newroot sleep <span class="m">1000</span> <span class="p">&amp;</span> <span class="nv">pid</span><span class="o">=</span><span class="nv">$!</span>
<span class="go">[4] 29988
</span><span class="gp">#</span> ls -la /proc/<span class="nv">$pid</span>/root
<span class="go">/newroot</span></pre></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="pivot-root">Pivot Root</h1></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><pre class="highlight ">+- /
|--- /usr
|--- /dev
|--- /home
\-+- /newroot
  |--- /nix
  |--- /dev
  \--- /tmp</pre></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> pivot_root /newroot /newroot/tmp
<span class="gp">#</span> umount /tmp</pre><p><em>Warning: modifies current mount namespace</em></p></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><pre class="highlight ">+- /  (was /newroot)
|--- /nix
|--- /dev
\-+- /tmp
  |--- /usr
  |--- /dev
  \--- /home</pre></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><pre class="highlight code console"><span class="go">mount --bind /dev /newroot/dev</span></pre></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="avoiding-mount-namespace-change">Avoiding Mount Namespace Change</h1><ul><li>openat()</li><li>linkat()</li><li>renameat()</li></ul></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="mount-namespace">Mount Namespace</h1></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> unshare --mount /bin/bash
<span class="gp">#</span> mount --make-rprivate /
<span class="gp">#</span> mount -t tmpfs tmpfs /tmp
<span class="gp">#</span> ls -la /tmp
<span class="go">total 16
drwxrwxrwt 2 root root  40 Jan 19 22:32 .
drwxr-xr-x 1 root root 142 Dec 13 16:14 ..
</span><span class="gp">#</span></pre></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="network-namespace">Network Namespace</h1></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> ip netns create isolated
<span class="gp">#</span> ip netns <span class="nb">exec </span>isolated ip addr
<span class="go">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></pre></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><pre class="highlight code console small"><span class="gp">#</span> ip netns <span class="nb">exec </span>isolated ip link <span class="nb">set </span>dev lo up
<span class="gp">#</span> ip netns <span class="nb">exec </span>isolated ip addr
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever</span></pre></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><pre class="highlight code console small"><span class="gp">#</span> ip netns <span class="nb">exec </span>isolated wget google.com
<span class="go">--2015-01-19 22:49:23--  http://google.com/
Resolving google.com (google.com)... 173.194.113.194, ...
Connecting to google.com (google.com)|173.194.113.194|:80...
failed: Network is unreachable.</span></pre></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="how-wget-resolves-ip">How Wget Resolves IP?</h1></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> ip netns <span class="nb">exec </span>isolated <span class="se">\
</span><span class="go">  strace -f -s 100 wget google.com</span></pre></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><pre class="highlight small">write(2, "Resolving google.com (google.com)... ", 37Resolving google.com (google.com)... ) = 37
socket(PF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3
connect(3, {sa_family=AF_LOCAL, sun_path="/var/run/nscd/socket"}, 110) = 0
sendto(3, "\2\0\0\0\r\0\0\0\6\0\0\0hosts\0", 18, MSG_NOSIGNAL, NULL, 0) = 18
poll([{fd=3, events=POLLIN|POLLERR|POLLHUP}], 1, 5000) = 1
recvmsg(3, {msg_name(0)=NULL, msg_iov(2)=[...]...}) = 14</pre></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> ip link add ext <span class="nb">type </span>veth peer name int
<span class="gp">#</span> ip link <span class="nb">set </span>int netns isolated
<span class="gp">#</span> ip addr add dev ext 192.168.17.1/24
<span class="gp">#</span> ip netns <span class="nb">exec</span> <span class="se">\
</span><span class="go">  ip addr add dev int 192.168.17.2/24</span></pre></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> unshare --net bash
<span class="gp">#</span> <span class="nb">echo</span> <span class="nv">$$</span>
<span class="go">12356
...
</span><span class="gp">#</span> touch /run/netns/isolated
<span class="gp">#</span> mount --bind /proc/12356/ns/net <span class="se">\
</span><span class="go">    /run/netns/isolated</span></pre></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> nsenter --net<span class="o">=</span>/run/netns/isolated /bin/bash</pre><p>The <tt>setns()</tt> system call</p></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> unshare --uts
<span class="gp">#</span> hostname something</pre></div><div class="step step-level-1" step="24" id="strike" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="38400" data-y="0" data-z="0"><ul><li>resolv.conf</li><li>hosts</li></ul></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40000" data-y="0" data-z="0"><p>unshare --ipc</p></div><div class="step step-level-1" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="41600" data-y="0" data-z="0"><pre class="highlight code console"><span class="gp">#</span> unshare --pid --fork sh -c <span class="s1">'echo $$'</span>
<span class="go">1</span></pre></div><div class="step step-level-1" step="27" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="43200" data-y="0" data-z="0"><h1 id="pid-namespace">Pid Namespace</h1><ul><li>/proc filesystem</li><li>security: ps, kill, strace</li></ul></div><div class="step step-level-1" step="28" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="44800" data-y="0" data-z="0"><h1 id="pid-1">Pid 1</h1><ul><li>KILL</li><li>reparenting</li><li>Term -&gt; Ignore</li></ul></div><div class="step step-level-1" step="29" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="46400" data-y="0" data-z="0"><img src="reparenting.png"></img></div><div class="step step-level-1" step="30" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="48000" data-y="0" data-z="0"><h1 id="not-a-pid-1">Not-a-Pid-1</h1><ul><li>KILL -&gt; <tt>prctl(PR_SET_PDEATHSIG)</tt></li><li>reparenting -&gt; <tt>prctl(PR_SET_CHILD_SUBREAPER)</tt></li><li>Term -&gt; Ignore (sigaction)</li></ul></div><div class="step step-level-1" step="31" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="49600" data-y="0" data-z="0"><p>unshare --user</p></div><div class="step step-level-1" step="32" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="51200" data-y="0" data-z="0"><h1 id="user-namespaces">User Namespaces</h1><ul><li>namespaces for unprivileged users</li><li>mapping of uids/gids</li></ul></div><div class="step step-level-1" step="33" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="52800" data-y="0" data-z="0"><pre class="highlight ">docker --net=host
docker --pid=host</pre></div><div class="step step-level-1" step="34" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="54400" data-y="0" data-z="0"><h1 id="competitors">Competitors</h1><ul><li>systemd-nspawn/machinectl</li><li>runc</li><li>rkt</li></ul></div><div class="step step-level-1" step="35" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="56000" data-y="0" data-z="0"><h1 id="rust">Rust</h1><ul><li><a href="https://crates.io/crates/unshare">https://crates.io/crates/unshare</a></li></ul></div><div class="step step-level-1" step="36" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="57600" data-y="0" data-z="0"><ul><li>nix</li><li>pbuilder</li><li>network shaping</li><li>packet loss</li><li>vagga</li></ul></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>